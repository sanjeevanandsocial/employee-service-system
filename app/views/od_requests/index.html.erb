<div class="page-header">
  <h1 class="page-title">OD Requests</h1>
  <div style="display: flex; gap: 10px;">
    <button type="button" onclick="toggleFilter()" class="toggle-filter-btn" id="toggleBtn">
      <i class="fas fa-filter"></i> Show Filters
    </button>
    <button type="button" onclick="openOdModal()" class="add-btn">
      <i class="fas fa-plus"></i> Apply New OD
    </button>
  </div>
</div>

<div class="filter-section" id="filterSection" style="display: none;">
  <%= form_with url: od_requests_path, method: :get, class: "filter-form" do |f| %>
    <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
      <div style="display: flex; gap: 15px; flex: 1; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 200px; max-width: 250px;">
          <%= f.label :from_date, "From Date", style: "display: block; font-size: 12px; color: #64748b; margin-bottom: 4px;" %>
          <%= f.date_field :from_date, value: params[:from_date], class: "filter-input", style: "width: 100%;" %>
        </div>
        <div style="flex: 1; min-width: 200px; max-width: 250px;">
          <%= f.label :to_date, "To Date", style: "display: block; font-size: 12px; color: #64748b; margin-bottom: 4px;" %>
          <%= f.date_field :to_date, value: params[:to_date], class: "filter-input", style: "width: 100%;" %>
        </div>
        <div style="flex: 1; min-width: 200px; max-width: 250px;">
          <%= f.label :status, "Status", style: "display: block; font-size: 12px; color: #64748b; margin-bottom: 4px;" %>
          <%= f.select :status, OdRequest.statuses.keys.map { |s| [s.titleize, s] }, { include_blank: "All Status", selected: params[:status] }, { class: "filter-input", style: "width: 100%;" } %>
        </div>
      </div>
      <div style="display: flex; gap: 10px; padding-top: 15px;">
        <%= f.button type: :submit, class: "filter-btn" do %>
          <i class="fas fa-search"></i> Search
        <% end %>
        <%= link_to od_requests_path, class: "clear-btn" do %>
          <i class="fas fa-times"></i> Clear
        <% end %>
      </div>
    </div>
  <% end %>
</div>

<div id="odModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); align-items: center; justify-content: center;" onclick="closeOdModal(event)">
  <div style="background: white; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; display: flex; flex-direction: column;" onclick="event.stopPropagation()">
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px 30px; border-bottom: 2px solid #e2e8f0;">
      <h2 style="font-size: 20px; font-weight: 600; color: #1e293b; margin: 0;">Apply for OD</h2>
      <button onclick="closeOdModal()" style="background: none; border: none; font-size: 24px; color: #64748b; cursor: pointer; padding: 0; width: 30px; height: 30px;">&times;</button>
    </div>
    <%= form_with model: @od_request, url: od_requests_path, local: true do |f| %>
      <div style="padding: 30px; overflow-y: auto; max-height: calc(90vh - 140px);">
        <% if @od_request.errors.any? %>
          <div style="background: #fee2e2; border: 1px solid #fecaca; border-radius: 6px; padding: 12px; margin-bottom: 20px;">
            <h4 style="color: #991b1b; margin: 0 0 8px 0; font-size: 14px;">Please fix the following errors:</h4>
            <ul style="margin: 0; padding-left: 20px; color: #991b1b; font-size: 13px;">
              <% @od_request.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>
        <div class="form-row">
          <div class="form-col">
            <div class="form-group">
              <%= f.label :from_date, "From Date *", class: "form-label" %>
              <%= f.date_field :from_date, class: "form-input", id: "from_date", onchange: "calculateDays()", max: Date.yesterday.strftime('%Y-%m-%d'), required: true %>
            </div>
          </div>
          <div class="form-col">
            <div class="form-group">
              <%= f.label :to_date, "To Date *", class: "form-label" %>
              <%= f.date_field :to_date, class: "form-input", id: "to_date", onchange: "calculateDays()", max: Date.yesterday.strftime('%Y-%m-%d'), required: true %>
            </div>
          </div>
        </div>
        <div id="days_count" style="color: #667eea; font-weight: 500; font-size: 14px; margin-bottom: 15px;"></div>
        <div class="form-group">
          <%= f.label :reason, "Reason *", class: "form-label" %>
          <%= f.text_area :reason, class: "form-input", rows: 3, placeholder: "Enter reason for OD", required: true %>
        </div>
      </div>
      <div style="padding: 20px 30px; border-top: 2px solid #e2e8f0; background: #f8fafc;">
        <div class="btn-group" style="margin: 0;">
          <%= f.submit "Apply", class: "btn-primary" %>
          <button type="button" onclick="closeOdModal()" class="btn-secondary">Cancel</button>
        </div>
      </div>
    <% end %>
  </div>
</div>

<script>
  function openOdModal() {
    document.getElementById('odModal').style.display = 'flex';
  }
  
  function closeOdModal(event) {
    if (!event || event.target.id === 'odModal') {
      document.getElementById('odModal').style.display = 'none';
    }
  }
  
  function toggleFilter() {
    const filterSection = document.getElementById('filterSection');
    const toggleBtn = document.getElementById('toggleBtn');
    if (filterSection.style.display === 'none') {
      filterSection.style.display = 'block';
      toggleBtn.innerHTML = '<i class="fas fa-filter"></i> Hide Filters';
    } else {
      filterSection.style.display = 'none';
      toggleBtn.innerHTML = '<i class="fas fa-filter"></i> Show Filters';
    }
  }
  
  function calculateDays() {
    const fromDate = document.getElementById('from_date').value;
    const toDate = document.getElementById('to_date').value;
    const daysCountEl = document.getElementById('days_count');
    
    if (fromDate && toDate) {
      const from = new Date(fromDate);
      const to = new Date(toDate);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      if (from >= today || to >= today) {
        daysCountEl.textContent = 'Dates must be before today';
        daysCountEl.style.color = '#ef4444';
        return;
      }
      
      const diffTime = to - from;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
      
      if (diffDays > 0) {
        daysCountEl.textContent = `Number of days: ${diffDays}`;
        daysCountEl.style.color = '#667eea';
      } else {
        daysCountEl.textContent = 'To date must be after from date';
        daysCountEl.style.color = '#ef4444';
      }
    } else {
      daysCountEl.textContent = '';
    }
  }
  
  <% if @show_modal %>
    document.addEventListener('DOMContentLoaded', function() {
      openOdModal();
    });
  <% end %>
</script>
<div class="total-records">
  Total Records: <%= @od_requests.total_count %>
</div>

<% if @od_requests.any? %>
  <table class="employees-table od-requests-table">
    <thead>
      <tr>
        <th style="text-align: right;">Applied On</th>
        <th style="text-align: right;">From Date</th>
        <th style="text-align: right;">To Date</th>
        <th style="text-align: right;">Total Days</th>
        <th style="width: 40%;">Reason</th>
        <th style="text-align: center;">Status</th>
      </tr>
    </thead>
    <tbody>
      <% @od_requests.each do |request| %>
        <tr>
          <td class="date-column" style="text-align: right;"><%= request.created_at.strftime('%-d %b %Y') %></td>
          <td class="date-column" style="text-align: right;"><%= request.from_date.strftime('%-d %b %Y') %></td>
          <td class="date-column" style="text-align: right;"><%= request.to_date.strftime('%-d %b %Y') %></td>
          <td style="text-align: right;"><%= request.total_days %></td>
          <td><%= request.reason %></td>
          <td style="text-align: center;">
            <span style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; 
              background: <%= request.pending? ? '#fef3c7' : request.approved? ? '#d1fae5' : request.cancelled? ? '#f3f4f6' : '#fee2e2' %>; 
              color: <%= request.pending? ? '#92400e' : request.approved? ? '#065f46' : request.cancelled? ? '#6b7280' : '#991b1b' %>;">
              <%= request.status.titleize %>
            </span>
          </td>
          <td style="text-align: right;">
            <div style="display: inline-flex; gap: 4px;">
              <% if request.pending? %>
                <%= button_to "Cancel", cancel_od_request_path(request), method: :patch, class: "action-btn", style: "background: #6b7280; color: #fff; border: none; cursor: pointer;" %>
              <% else %>
                <span style="color: #64748b; font-size: 12px;">No action needed</span>
              <% end %>
            </div>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
  
  <div class="table-footer">
    <%= link_to od_requests_path(format: :csv, from_date: params[:from_date], to_date: params[:to_date], status: params[:status]), class: "export-csv-btn" do %>
      <i class="fas fa-download"></i> Export as CSV
    <% end %>
    <div class="pagination-container">
      <%= paginate @od_requests %>
    </div>
  </div>
<% else %>
  <div class="empty-state">
    <div class="empty-icon"><i class="fas fa-calendar-check"></i></div>
    <h2 class="empty-title">No OD Requests</h2>
    <p class="empty-message">You haven't applied for any OD requests yet.</p>
  </div>
<% end %>
