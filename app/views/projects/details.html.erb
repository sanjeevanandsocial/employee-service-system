<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<style>
  .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); }
  .modal.active { display: flex; align-items: center; justify-content: center; }
  .modal-content { background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); max-height: 90vh; overflow-y: auto; margin: auto; }
  .task-modal-content { background: white; border-radius: 12px; max-width: 800px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); max-height: 90vh; margin: auto; display: flex; flex-direction: column; }
  .task-modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 30px; border-bottom: 2px solid #e2e8f0; }
  .task-modal-body { padding: 30px; overflow-y: auto; max-height: calc(90vh - 140px); }
  .task-modal-footer { padding: 20px 30px; border-top: 2px solid #e2e8f0; background: #f8fafc; }
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e2e8f0; }
  .modal-title { font-size: 20px; font-weight: 600; color: #1e293b; margin: 0; }
  .modal-close { background: none; border: none; font-size: 24px; color: #64748b; cursor: pointer; padding: 0; width: 30px; height: 30px; }
  .modal-close:hover { color: #1e293b; }
  .modal-info-row { display: flex; padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
  .modal-info-row:last-child { border-bottom: none; }
  .modal-info-label { font-weight: 600; color: #64748b; width: 140px; font-size: 14px; }
  .modal-info-value { color: #1e293b; font-size: 14px; flex: 1; }
  .tabs-container { background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; }
  .tabs-nav { display: flex; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
  .tab-button { flex: 1; padding: 16px 20px; background: none; border: none; cursor: pointer; font-weight: 500; font-size: 14px; color: #64748b; transition: all 0.3s ease; border-bottom: 3px solid transparent; display: flex; align-items: center; justify-content: center; gap: 8px; }
  .tab-button.active { color: #667eea; border-bottom-color: #667eea; background: white; }
  .tab-button:hover { color: #667eea; background: rgba(102, 126, 234, 0.05); }
  .tab-content { display: none; padding: 24px; }
  .tab-content.active { display: block; }
  .empty-state { text-align: center; padding: 40px 20px; color: #64748b; }
  .empty-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
  .project-details-add-btn { border: 0; display: inline-block; }
  .page-header .btn-secondary { padding: 8px 14px; font-size: 13px; }
  .tab-content .form-input, .tab-content .form-select { padding: 6px 10px; font-size: 13px; height: 32px; }
  .tab-content .add-btn { padding: 6px 12px; font-size: 13px; }
</style>

<div class="page-header">
  <div style="font-size: 16px; color: #64748b; font-weight: 500;">Project #<%= @project.id %></div>
  <div style="display: flex; gap: 10px; align-items: center;">
    <button onclick="openModal()" class="btn-secondary" style="cursor: pointer;"><i class="fas fa-info-circle"></i> Project Details</button>
    <%= link_to projects_path, class: "btn-secondary" do %><i class="fas fa-arrow-left"></i> Back<% end %>
  </div>
</div>

<div id="projectModal" class="modal" onclick="closeModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Project Information</h2>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div>
      <div class="modal-info-row"><div class="modal-info-label">Project ID:</div><div class="modal-info-value">#<%= @project.id %></div></div>
      <div class="modal-info-row"><div class="modal-info-label">Title:</div><div class="modal-info-value"><%= @project.title %></div></div>
      <div class="modal-info-row">
        <div class="modal-info-label">Status:</div>
        <div class="modal-info-value">
          <% status_class = case @project.status when "planned" then "status-paused" when "in_progress" then "status-active" when "on_hold" then "status-paused" when "completed" then "status-completed" when "cancelled" then "status-frozen" end %>
          <span class="status-badge <%= status_class %>"><%= @project.status.gsub('_', ' ').titleize %></span>
        </div>
      </div>
      <div class="modal-info-row"><div class="modal-info-label">Created At:</div><div class="modal-info-value"><%= format_display_date(@project.created_at.to_date) %></div></div>
      <div class="modal-info-row"><div class="modal-info-label">Start Date:</div><div class="modal-info-value"><%= format_display_date(@project.start_date) %></div></div>
      <div class="modal-info-row"><div class="modal-info-label">End Date:</div><div class="modal-info-value"><%= format_display_date(@project.end_date) %></div></div>
    </div>
  </div>
</div>

<div id="addEmployeeModal" class="modal" onclick="closeAddEmployeeModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header"><h2 class="modal-title">Add Employee to Project</h2><button class="modal-close" onclick="closeAddEmployeeModal()">&times;</button></div>
    <%= form_with url: project_project_employees_path(@project), method: :post do |f| %>
      <div class="form-group"><%= f.label :user_id, "Select Employee", class: "form-label" %><%= f.select :user_id, User.where(role: :employee).where.not(id: @project.user_ids).map { |u| [u.email, u.id] }, { prompt: "Choose an employee" }, { class: "form-select" } %></div>
      <div class="btn-group"><%= f.submit "Add Employee", class: "btn-primary" %><button type="button" onclick="closeAddEmployeeModal()" class="btn-secondary">Cancel</button></div>
    <% end %>
  </div>
</div>

<div class="tabs-container">
  <div class="tabs-nav">
    <button class="tab-button active" onclick="switchTab('employees', this)">
      <i class="fas fa-users"></i> Employees
      <span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 5px;"><%= @project.users.count %></span>
    </button>
  </div>
  
  <div id="employees-tab" class="tab-content active">
    <% if @project.users.any? %>
      <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; gap: 10px;">
          <input type="text" id="empIdFilter" placeholder="Filter by ID" class="form-input" style="width: 150px;" onkeyup="filterEmployees()">
          <input type="text" id="empEmailFilter" placeholder="Filter by Email" class="form-input" style="width: 200px;" onkeyup="filterEmployees()">
        </div>
        <button onclick="openAddEmployeeModal()" class="add-btn" style="border:0;"><i class="fas fa-plus"></i> Add Employee</button>
      </div>
      <table class="employees-table">
        <thead><tr><th>ID</th><th>Email</th><th>Role</th><th style="text-align: right;">Actions</th></tr></thead>
        <tbody>
          <% @project.users.each do |user| %>
            <tr>
              <td><%= user.id %></td>
              <td><span class="email-cell"><i class="far fa-user-circle"></i><span class="email-text"><%= user.email %></span></span></td>
              <td><%= user.role.capitalize %></td>
              <td style="text-align: right;"><%= button_to project_project_employee_path(@project, @project.project_employees.find_by(user_id: user.id)), method: :delete, class: "action-btn btn-edit", style: "border: 0; cursor: pointer;", data: { confirm: "Remove this employee?" } do %><i class="fas fa-trash"></i> Remove<% end %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div class="empty-state"><button onclick="openAddEmployeeModal()" class="add-btn project-details-add-btn" style="margin-bottom: 30px;"><i class="fas fa-plus"></i> Add Employee</button><div class="empty-icon"><i class="fas fa-users"></i></div><h3>No Employees Assigned</h3><p>Employee assignments will be displayed here.</p></div>
    <% end %>
  </div>
  

</div>

<div id="addTaskModal" class="modal" onclick="closeAddTaskModal(event)">
  <div class="task-modal-content" onclick="event.stopPropagation()">
    <div class="task-modal-header"><h2 class="modal-title">Create New Task</h2><button class="modal-close" onclick="closeAddTaskModal()">&times;</button></div>
    <%= form_with model: [@project, @project.tasks.new], local: true, id: "task_form" do |f| %>
      <div class="task-modal-body">
        <div class="form-group"><%= f.label :title, "Task Title", class: "form-label" %><%= f.text_field :title, class: "form-input", placeholder: "Enter task title", id: "task_title_input" %></div>
        <div class="form-group"><%= f.label :description, "Description", class: "form-label" %><div id="quill-editor" style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; min-height: 150px;"></div><%= f.hidden_field :description, id: "task_description_input" %></div>
        <div class="form-row">
          <div class="form-group"><%= f.label :priority, "Priority", class: "form-label" %><%= f.select :priority, Task.priorities.keys.map { |k| [k.titleize, k] }, {}, class: "form-select" %></div>
          <div class="form-group"><%= f.label :due_date, "Due Date", class: "form-label" %><%= f.date_field :due_date, class: "form-input" %></div>
        </div>
        <div class="form-row">
          <div class="form-group"><%= f.label :status, "Status", class: "form-label" %><%= f.select :status, Task.statuses.keys.map { |k| [k.gsub('_', ' ').titleize, k] }, {}, class: "form-select" %></div>
          <div class="form-group"><%= f.label :assigned_to_id, "Assigned To", class: "form-label" %><%= f.select :assigned_to_id, @project.users.map { |u| [u.email, u.id] }, { prompt: "Select employee" }, class: "form-select" %></div>
        </div>
        <div class="form-row">
          <div class="form-group"><%= f.label :category, "Category", class: "form-label" %><%= f.select :category, Task.categories.keys.map { |k| [k.gsub('_', ' ').titleize, k] }, {}, class: "form-select" %></div>
          <div class="form-group"><%= f.label :estimated_time, "Estimated Time", class: "form-label" %><%= f.text_field :estimated_time, class: "form-input", placeholder: "e.g., 5 hours, 2 days" %></div>
        </div>
      </div>
      <div class="task-modal-footer"><div class="btn-group" style="margin: 0;"><%= f.submit "Create Task", class: "btn-primary" %><button type="button" onclick="closeAddTaskModal()" class="btn-secondary">Cancel</button></div></div>
    <% end %>
  </div>
</div>

<% @project.tasks.each do |task| %>
<div id="editTaskModal<%= task.id %>" class="modal" onclick="closeEditTaskModal(<%= task.id %>, event)">
  <div class="task-modal-content" onclick="event.stopPropagation()">
    <div class="task-modal-header"><h2 class="modal-title">Edit Task</h2><button class="modal-close" onclick="closeEditTaskModal(<%= task.id %>)">&times;</button></div>
    <%= form_with model: [@project, task], local: true do |f| %>
      <div class="task-modal-body">
        <div class="form-group"><%= f.label :title, "Task Title", class: "form-label" %><%= f.text_field :title, class: "form-input" %></div>
        <div class="form-group"><%= f.label :description, "Description", class: "form-label" %><div id="quill-editor-<%= task.id %>" style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; min-height: 150px;"></div><%= f.hidden_field :description, id: "task_description_#{task.id}" %></div>
        <div class="form-row">
          <div class="form-group"><%= f.label :priority, "Priority", class: "form-label" %><%= f.select :priority, Task.priorities.keys.map { |k| [k.titleize, k] }, {}, class: "form-select" %></div>
          <div class="form-group"><%= f.label :due_date, "Due Date", class: "form-label" %><%= f.date_field :due_date, class: "form-input" %></div>
        </div>
        <div class="form-row">
          <div class="form-group"><%= f.label :status, "Status", class: "form-label" %><%= f.select :status, Task.statuses.keys.map { |k| [k.gsub('_', ' ').titleize, k] }, {}, class: "form-select" %></div>
          <div class="form-group"><%= f.label :assigned_to_id, "Assigned To", class: "form-label" %><%= f.select :assigned_to_id, @project.users.map { |u| [u.email, u.id] }, { prompt: "Select employee" }, class: "form-select" %></div>
        </div>
        <div class="form-row">
          <div class="form-group"><%= f.label :category, "Category", class: "form-label" %><%= f.select :category, Task.categories.keys.map { |k| [k.gsub('_', ' ').titleize, k] }, {}, class: "form-select" %></div>
          <div class="form-group"><%= f.label :estimated_time, "Estimated Time", class: "form-label" %><%= f.text_field :estimated_time, class: "form-input" %></div>
        </div>
        <div class="form-group" style="margin-top: 20px;">
          <%= f.label :comment, "Add Comment", class: "form-label" %>
          <%= f.text_area :comment, class: "form-input", rows: 2, placeholder: "Add a comment..." %>
        </div>
      </div>
      <div class="task-modal-footer"><div class="btn-group" style="margin: 0;"><%= f.submit "Update Task", class: "btn-primary" %><button type="button" onclick="closeEditTaskModal(<%= task.id %>)" class="btn-secondary">Cancel</button></div></div>
    <% end %>
  </div>
</div>
<div id="commentsModal<%= task.id %>" class="modal" onclick="closeCommentsModal(<%= task.id %>, event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header"><h2 class="modal-title">Comments & Activity Log</h2><button class="modal-close" onclick="closeCommentsModal(<%= task.id %>)">&times;</button></div>
    <div>
      <% if task.task_activities.any? %>
        <% task.task_activities.order(created_at: :desc).each do |activity| %>
          <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #e2e8f0;">
            <div style="font-weight: 600; color: #1e293b; font-size: 13px;"><%= activity.user.email %></div>
            <div style="color: #94a3b8; font-size: 12px; margin: 2px 0 5px 0;">(<%= activity.created_at.strftime('%-d %b %Y') %>)</div>
            <div style="color: #64748b; font-size: 13px;"><%= activity.comment %></div>
          </div>
        <% end %>
      <% else %>
        <p style="margin: 0; color: #94a3b8; font-size: 13px;">No activity yet.</p>
      <% end %>
    </div>
  </div>
</div>
<% end %>

<script>
function switchTab(tabName, clickedButton) {
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
  document.getElementById(tabName + '-tab').classList.add('active');
  if (clickedButton) {
    clickedButton.classList.add('active');
  } else {
    document.querySelectorAll('.tab-button').forEach(btn => {
      if (btn.textContent.toLowerCase().includes(tabName)) btn.classList.add('active');
    });
  }
}
function openModal() { document.getElementById('projectModal').classList.add('active'); }
function closeModal(event) { if (!event || event.target.id === 'projectModal') document.getElementById('projectModal').classList.remove('active'); }
function openAddEmployeeModal() { document.getElementById('addEmployeeModal').classList.add('active'); }
function closeAddEmployeeModal(event) { if (!event || event.target.id === 'addEmployeeModal') document.getElementById('addEmployeeModal').classList.remove('active'); }
function openAddTaskModal() { document.getElementById('addTaskModal').classList.add('active'); if (quill) quill.setText(''); }
function closeAddTaskModal(event) { if (!event || event.target.id === 'addTaskModal') document.getElementById('addTaskModal').classList.remove('active'); }

let quill;
const editQuills = {};

document.addEventListener('DOMContentLoaded', function() {
  const titleInput = document.getElementById('task_title_input');
  if (titleInput) {
    titleInput.addEventListener('input', function(e) {
      if (this.value.length === 1) this.value = this.value.charAt(0).toUpperCase();
    });
  }

  if (document.getElementById('quill-editor')) {
    quill = new Quill('#quill-editor', {
      theme: 'snow',
      placeholder: 'Enter task description...',
      modules: { toolbar: [['bold', 'italic', 'underline'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['clean']] }
    });
    quill.on('text-change', function() {
      document.getElementById('task_description_input').value = quill.root.innerHTML;
    });
  }
});

function openEditTaskModal(taskId) {
  document.getElementById('editTaskModal' + taskId).classList.add('active');
  if (!editQuills[taskId]) {
    editQuills[taskId] = new Quill('#quill-editor-' + taskId, {
      theme: 'snow',
      placeholder: 'Enter task description...',
      modules: { toolbar: [['bold', 'italic', 'underline'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['clean']] }
    });
    const existingDesc = document.getElementById('task_description_' + taskId).value;
    if (existingDesc) editQuills[taskId].root.innerHTML = existingDesc;
    editQuills[taskId].on('text-change', function() {
      document.getElementById('task_description_' + taskId).value = editQuills[taskId].root.innerHTML;
    });
  }
}

function closeEditTaskModal(taskId, event) {
  if (!event || event.target.id === 'editTaskModal' + taskId) {
    document.getElementById('editTaskModal' + taskId).classList.remove('active');
  }
}

function openCommentsModal(taskId) {
  document.getElementById('commentsModal' + taskId).classList.add('active');
}

function closeCommentsModal(taskId, event) {
  if (!event || event.target.id === 'commentsModal' + taskId) {
    document.getElementById('commentsModal' + taskId).classList.remove('active');
  }
}

function filterEmployees() {
  const idFilter = document.getElementById('empIdFilter').value.toLowerCase();
  const emailFilter = document.getElementById('empEmailFilter').value.toLowerCase();
  const table = document.querySelector('#employees-tab .employees-table tbody');
  const rows = Array.from(table.getElementsByTagName('tr'));
  
  rows.forEach(row => {
    const id = row.cells[0].textContent.toLowerCase();
    const email = row.cells[1].textContent.toLowerCase();
    row.style.display = (id.includes(idFilter) && email.includes(emailFilter)) ? '' : 'none';
  });
}

function filterTasks() {
  const titleFilter = document.getElementById('taskTitleFilter').value.toLowerCase();
  const priorityFilter = document.getElementById('taskPriorityFilter').value.toLowerCase();
  const statusFilter = document.getElementById('taskStatusFilter').value.toLowerCase();
  const table = document.querySelector('#tasks-tab .employees-table tbody');
  const rows = Array.from(table.getElementsByTagName('tr'));
  
  rows.forEach(row => {
    const title = row.cells[0].textContent.toLowerCase();
    const priority = row.cells[1].textContent.toLowerCase();
    const status = row.cells[2].textContent.toLowerCase();
    row.style.display = (title.includes(titleFilter) && (!priorityFilter || priority.includes(priorityFilter)) && (!statusFilter || status.includes(statusFilter))) ? '' : 'none';
  });
}

if (window.location.hash === '#tasks-tab') {
  document.addEventListener('DOMContentLoaded', function() {
    switchTab('tasks');
  });
}
</script>
